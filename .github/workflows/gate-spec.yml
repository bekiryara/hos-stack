name: Gate SPEC

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main, develop]

jobs:
  gate-spec:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check SPEC.md exists
        id: check_spec
        run: |
          if (-not (Test-Path "docs/SPEC.md")) {
            Write-Host "FAIL: docs/SPEC.md does not exist" -ForegroundColor Red
            exit 1
          }
          Write-Host "PASS: docs/SPEC.md exists" -ForegroundColor Green

      - name: Check CURRENT.md exists
        id: check_current
        run: |
          if (-not (Test-Path "docs/CURRENT.md")) {
            Write-Host "FAIL: docs/CURRENT.md does not exist" -ForegroundColor Red
            exit 1
          }
          Write-Host "PASS: docs/CURRENT.md exists" -ForegroundColor Green

      - name: Check PR description for SPEC Reference
        id: check_pr_spec_ref
        if: github.event_name == 'pull_request'
        run: |
          $prBody = $env:GITHUB_PR_BODY
          if ([string]::IsNullOrWhiteSpace($prBody)) {
            Write-Host "WARN: PR description is empty" -ForegroundColor Yellow
            Write-Host "INFO: SPEC Reference check skipped (empty PR body)" -ForegroundColor Cyan
            exit 0
          }
          
          # Check for SPEC Reference pattern (VAR — § or YOK → EK — §)
          if ($prBody -match "(?i)(VAR\s*—|YOK\s*→\s*EK\s*—)\s*§") {
            Write-Host "PASS: PR description contains SPEC Reference" -ForegroundColor Green
            exit 0
          }
          
          Write-Host "FAIL: PR description must contain 'SPEC Reference' line" -ForegroundColor Red
          Write-Host "Expected format: 'VAR — §X.Y' or 'YOK → EK — §X.Y'" -ForegroundColor Yellow
          exit 1
        env:
          GITHUB_PR_BODY: ${{ github.event.pull_request.body }}

      - name: Gate SPEC Summary
        run: |
          Write-Host "=== Gate SPEC Check ===" -ForegroundColor Cyan
          Write-Host "SPEC.md: PASS" -ForegroundColor Green
          Write-Host "CURRENT.md: PASS" -ForegroundColor Green
          if ("${{ github.event_name }}" -eq "pull_request") {
            Write-Host "PR SPEC Reference: PASS" -ForegroundColor Green
          }
          Write-Host "=== Gate SPEC: PASS ===" -ForegroundColor Green








