name: Gate Write Snapshot (WP-24)

on:
  pull_request:
    paths:
      - 'work/pazar/routes/api/**/*.php'
      - 'contracts/api/marketplace.write.snapshot.json'
      - 'ops/write_snapshot_check.ps1'
      - 'ops/state_transition_guard.ps1'
      - 'ops/idempotency_coverage_check.ps1'

jobs:
  write-snapshot-check:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Write Snapshot Check
        shell: pwsh
        run: |
          .\ops\write_snapshot_check.ps1
      
      - name: Run State Transition Guard
        shell: pwsh
        run: |
          .\ops\state_transition_guard.ps1
      
      - name: Run Idempotency Coverage Check
        shell: pwsh
        run: |
          .\ops\idempotency_coverage_check.ps1
      
      - name: Check exit code
        if: failure()
        run: |
          Write-Host "FAIL: Write snapshot check failed. WRITE endpoints must match snapshot files." -ForegroundColor Red
          Write-Host "Update contracts/api/marketplace.write.snapshot.json or fix routes/api/*.php" -ForegroundColor Yellow
          exit 1


