name: CI Baseline Governance

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  repo_integrity:
    name: Repository Integrity
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run repo integrity check
        shell: pwsh
        run: |
          if (Test-Path "ops\repo_integrity.ps1") {
            .\ops\repo_integrity.ps1
          } else {
            # Fallback to doctor.ps1 repo integrity section
            .\ops\doctor.ps1
          }
      
      - name: Run CI Guard
        shell: pwsh
        run: |
          .\ops\ci_guard.ps1
          $exitCode = $LASTEXITCODE
          if ($exitCode -eq 1) {
            Write-Host "FAIL: CI Guard detected drift" -ForegroundColor Red
            exit 1
          } elseif ($exitCode -eq 2) {
            Write-Host "WARN: CI Guard detected warnings (non-blocking)" -ForegroundColor Yellow
            exit 0
          } else {
            Write-Host "PASS: CI Guard passed" -ForegroundColor Green
            exit 0
          }
      
      - name: Check git status is clean
        shell: pwsh
        run: |
          $status = git status --porcelain
          if ($status) {
            Write-Host "FAIL: Git status is not clean after scripts" -ForegroundColor Red
            Write-Host "Uncommitted changes:" -ForegroundColor Yellow
            Write-Host $status
            exit 1
          }
          Write-Host "PASS: Git status is clean" -ForegroundColor Green
      
      - name: Run graveyard check
        shell: pwsh
        run: |
          .\ops\graveyard_check.ps1

  verify:
    name: Verify
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Docker availability
        shell: pwsh
        run: |
          $dockerAvailable = $false
          try {
            docker --version | Out-Null
            if ($LASTEXITCODE -eq 0) {
              $dockerAvailable = $true
            }
          } catch {
            $dockerAvailable = $false
          }
          
          if (-not $dockerAvailable) {
            Write-Host "DOCKER_NOT_AVAILABLE: Docker is not available in this runner" -ForegroundColor Yellow
            Write-Host "Skipping verify.ps1 (requires Docker)" -ForegroundColor Yellow
            exit 0
          }
          Write-Host "Docker is available" -ForegroundColor Green
          $env:DOCKER_AVAILABLE = "true"
      
      - name: Run verify.ps1
        shell: pwsh
        if: env.DOCKER_AVAILABLE == 'true'
        run: |
          .\ops\verify.ps1 | Tee-Object -FilePath verify.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "FAIL: verify.ps1 returned exit code $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }
        continue-on-error: false

  conformance:
    name: Conformance
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run conformance.ps1
        shell: pwsh
        run: |
          .\ops\conformance.ps1 | Tee-Object -FilePath conformance.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "FAIL: conformance.ps1 returned exit code $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }
        continue-on-error: false
      
      - name: Run baseline_status.ps1
        shell: pwsh
        run: |
          # baseline_status.ps1 checks Docker, so handle gracefully
          $dockerAvailable = $false
          try {
            docker --version | Out-Null
            if ($LASTEXITCODE -eq 0) {
              $dockerAvailable = $true
            }
          } catch {
            $dockerAvailable = $false
          }
          
          if (-not $dockerAvailable) {
            Write-Host "DOCKER_NOT_AVAILABLE: Skipping baseline_status.ps1 (requires Docker)" -ForegroundColor Yellow
            exit 0
          }
          
          .\ops\baseline_status.ps1 | Tee-Object -FilePath baseline_status.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "FAIL: baseline_status.ps1 returned exit code $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }
        continue-on-error: false
      
      - name: Upload check artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: check-outputs
          path: |
            verify.txt
            conformance.txt
            baseline_status.txt
          retention-days: 7

  snapshot_policy:
    name: Snapshot Policy
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for proof doc requirement
        shell: pwsh
        run: |
          # Get changed files in PR
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $base = $env:GITHUB_BASE_REF
            $head = $env:GITHUB_HEAD_REF
            $changedFiles = git diff --name-only "$base...$head" | Where-Object { $_ -notmatch "^docs/" -and $_ -notmatch "^.github/" -and $_ -notmatch "^CHANGELOG" }
          } else {
            $changedFiles = git diff --name-only HEAD~1 HEAD | Where-Object { $_ -notmatch "^docs/" -and $_ -notmatch "^.github/" -and $_ -notmatch "^CHANGELOG" }
          }
          
          if ($changedFiles) {
            Write-Host "Code changes detected. Checking for proof doc..." -ForegroundColor Yellow
            $proofFiles = git diff --name-only "$base...$head" 2>$null | Where-Object { $_ -match "^docs/PROOFS/" }
            if (-not $proofFiles) {
              Write-Host "WARN: Code changed but no proof doc found in docs/PROOFS/" -ForegroundColor Yellow
              Write-Host "Consider adding a proof doc under docs/PROOFS/ for this change" -ForegroundColor Yellow
            } else {
              Write-Host "PASS: Proof doc found" -ForegroundColor Green
            }
          } else {
            Write-Host "PASS: No code changes (docs-only)" -ForegroundColor Green
          }
      
      - name: Check CHANGELOG for baseline-impacting changes
        shell: pwsh
        run: |
          # Check if docker-compose.yml, ops/verify.ps1, docs/CURRENT.md changed
          $baselineFiles = @("docker-compose.yml", "ops/verify.ps1", "ops/baseline_status.ps1", "docs/CURRENT.md", "docs/DECISIONS.md")
          
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $base = $env:GITHUB_BASE_REF
            $head = $env:GITHUB_HEAD_REF
            $changedFiles = git diff --name-only "$base...$head"
          } else {
            $changedFiles = git diff --name-only HEAD~1 HEAD
          }
          
          $baselineChanged = $false
          foreach ($file in $baselineFiles) {
            if ($changedFiles -contains $file) {
              $baselineChanged = $true
              break
            }
          }
          
          if ($baselineChanged) {
            Write-Host "Baseline-impacting file changed. Checking CHANGELOG..." -ForegroundColor Yellow
            $changelogEntry = git diff "$base...$head" CHANGELOG.md 2>$null | Select-String -Pattern "^\+\s*\*\*.*BASELINE|baseline|BASELINE" -CaseSensitive:$false
            if (-not $changelogEntry) {
              Write-Host "WARN: Baseline-impacting change detected but no CHANGELOG entry found" -ForegroundColor Yellow
              Write-Host "Consider adding a CHANGELOG entry for baseline-impacting changes" -ForegroundColor Yellow
            } else {
              Write-Host "PASS: CHANGELOG entry found" -ForegroundColor Green
            }
          } else {
            Write-Host "PASS: No baseline-impacting changes" -ForegroundColor Green
          }
      
      - name: Check CURRENT.md updated for port/service changes
        shell: pwsh
        run: |
          # Check if docker-compose.yml ports/services changed
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $base = $env:GITHUB_BASE_REF
            $head = $env:GITHUB_HEAD_REF
            $composeDiff = git diff "$base...$head" docker-compose.yml 2>$null
          } else {
            $composeDiff = git diff HEAD~1 HEAD docker-compose.yml 2>$null
          }
          
          if ($composeDiff -match "ports:|services:") {
            Write-Host "Docker Compose ports/services changed. Checking docs/CURRENT.md..." -ForegroundColor Yellow
            $currentDiff = git diff "$base...$head" docs/CURRENT.md 2>$null
            if (-not $currentDiff -or ($currentDiff -notmatch "port|Port|PORT|service|Service|SERVICE")) {
              Write-Host "WARN: Port/service changed but docs/CURRENT.md not updated" -ForegroundColor Yellow
              Write-Host "Consider updating docs/CURRENT.md with new port/service information" -ForegroundColor Yellow
            } else {
              Write-Host "PASS: docs/CURRENT.md updated" -ForegroundColor Green
            }
          } else {
            Write-Host "PASS: No port/service changes" -ForegroundColor Green
          }


