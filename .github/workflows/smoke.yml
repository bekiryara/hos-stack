name: Smoke Check

on:
  pull_request:
    branches: ['*']
  push:
    branches: ['*']

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          echo "Starting docker compose services..."
          docker compose up -d --build
          echo "Waiting for services to be ready..."
          sleep 10

      - name: Check container status
        run: |
          echo "=== Container Status ==="
          docker compose ps
          echo ""
          # Verify all containers are up
          if docker compose ps | grep -q "Restarting\|Exited"; then
            echo "❌ FAIL: Some containers are not running"
            docker compose ps
            exit 1
          fi
          echo "✅ PASS: All containers are up"

      - name: H-OS health check
        run: |
          echo "=== H-OS Health Check ==="
          for i in {1..30}; do
            if curl -fsS http://localhost:3000/v1/health | grep -q '"ok":true'; then
              echo "✅ PASS: H-OS health check passed"
              curl -fsS http://localhost:3000/v1/health
              exit 0
            fi
            echo "Waiting for H-OS... ($i/30)"
            sleep 2
          done
          echo "❌ FAIL: H-OS health check failed"
          exit 1

      - name: Pazar health check
        run: |
          echo "=== Pazar Health Check ==="
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/up | grep -q .; then
              STATUS=$(curl -fsS -o /dev/null -w "%{http_code}" http://localhost:8080/up)
              if [ "$STATUS" = "200" ]; then
                echo "✅ PASS: Pazar health check passed (HTTP $STATUS)"
                exit 0
              fi
            fi
            echo "Waiting for Pazar... ($i/30)"
            sleep 2
          done
          echo "❌ FAIL: Pazar health check failed"
          exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Container Logs (last 200 lines) ==="
          docker compose logs --tail=200

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleanup ==="
          docker compose down -v

