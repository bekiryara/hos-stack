name: Gate Pazar Spine

on:
  pull_request:
    paths:
      - 'work/pazar/**'
      - 'ops/pazar_spine_check.ps1'
      - 'ops/world_status_check.ps1'
      - 'ops/catalog_contract_check.ps1'
      - 'ops/listing_contract_check.ps1'
      - 'ops/reservation_contract_check.ps1'
      - 'docs/SPEC.md'
      - '.github/workflows/gate-pazar-spine.yml'
  push:
    branches:
      - main
    paths:
      - 'work/pazar/**'
      - 'ops/pazar_spine_check.ps1'
      - '.github/workflows/gate-pazar-spine.yml'

jobs:
  gate-pazar-spine:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check SPEC.md exists
        run: |
          if [ ! -f "docs/SPEC.md" ]; then
            echo "ERROR: docs/SPEC.md is missing. SPEC is required as single source of truth."
            exit 1
          fi
          echo "PASS: docs/SPEC.md exists"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start services
        run: |
          docker compose up -d --build
          sleep 10
      
      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080/up && curl -f http://localhost:3000/v1/health; do sleep 2; done'
      
      - name: Run migrations
        run: |
          docker compose exec -T pazar-app php artisan migrate --force
      
      - name: Seed required data
        run: |
          docker compose exec -T pazar-app php artisan db:seed --class=CatalogSpineSeeder --force
        continue-on-error: false
      
      - name: Install PowerShell
        uses: microsoft/setup-powershell@v1
      
      - name: Run Pazar Spine Check
        run: |
          pwsh -File ./ops/pazar_spine_check.ps1
        continue-on-error: false

