services:
  db:
    secrets:
      - db_password
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      # ensure plain var doesn't need to exist in the shell
      POSTGRES_PASSWORD: ""

  postgres-exporter:
    secrets:
      - db_password
    # In secrets mode, read DB password from Docker secret so exporter does not drift from DB.
    entrypoint:
      - sh
      - -lc
      - |
          # Strip UTF-8 BOM and CRLF/newlines from the secret file (Windows PowerShell writes UTF-8 BOM by default).
          # IMPORTANT: docker compose interpolates variables at config time; use $$ to defer to shell runtime.
          bom="$$(printf '\357\273\277')"
          raw="$$(cat /run/secrets/db_password | tr -d '\r\n')"
          case "$$raw" in
            "$$bom"*) raw="$${raw#$$bom}" ;;
          esac
          export PGPASSWORD="$$raw"
          export DATA_SOURCE_NAME="postgresql://$${POSTGRES_USER:-hos}:$$PGPASSWORD@db:5432/$${POSTGRES_DB:-hos}?sslmode=disable"
          exec /bin/postgres_exporter

  api:
    secrets:
      - jwt_secret
      - database_url
      - google_client_id
      - google_client_secret
      - google_redirect_uri
    environment:
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      DATABASE_URL_FILE: /run/secrets/database_url
      GOOGLE_CLIENT_ID_FILE: /run/secrets/google_client_id
      GOOGLE_CLIENT_SECRET_FILE: /run/secrets/google_client_secret
      GOOGLE_REDIRECT_URI_FILE: /run/secrets/google_redirect_uri
      # Ensure env vars from base compose don't override *_FILE (config prefers env when non-empty)
      JWT_SECRET: ""
      DATABASE_URL: ""

secrets:
  db_password:
    file: ./secrets/db_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  database_url:
    file: ./secrets/database_url.txt
  google_client_id:
    file: ./secrets/google_client_id.txt
  google_client_secret:
    file: ./secrets/google_client_secret.txt
  google_redirect_uri:
    file: ./secrets/google_redirect_uri.txt


