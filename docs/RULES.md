# RULES

1. **Scratch yok**: Yeni özellik ekleme, büyük refactor yapma
2. **Küçük patch**: Sadece minimal, gerekli değişiklik
3. **Proof zorunlu**: Her değişiklik için test/smoke/proof kanıtı
4. **NO PASS, NO NEXT STEP**: Adım PASS olmadan devam etme
5. **Controller kural yazmaz**: Business logic → `HosGate`, controller sadece UI
6. **Shadow → enforce**: Breaking change için önce shadow, sonra enforce
7. **Kanıtsız merge yok**: PR'da proof olmadan merge yok
8. **Dokümantasyon güncelle**: Değişiklik yapıyorsan ilgili dokümanı güncelle
9. **Secrets korumalı**: `.gitignore`'da secrets var, asla commit etme
10. **Stack bozma**: Değişiklik yaparken çalışan stack'i bozma
11. **Scratch/root artifacts PR'da fail olur**: GitHub Actions repo guard workflow root'ta zip/rar/temp dosyaları engeller
12. **Archive sadece _archive altına**: Scratch dosyalar sadece `_archive/` klasörüne taşınır, root'ta kalmaz
13. **Runtime log'lar asla git'e girmez**: `storage/logs/*.log` dosyaları tracked olmamalı, gitignore'da olmalı
14. **PR merge için repo-guard + smoke PASS zorunlu**: GitHub Actions workflow'ları (repo-guard + smoke) PASS olmadan PR merge edilemez
15. **PR merge için conformance PASS zorunlu**: Mimari kurallar (world registry, disabled-world code, canonical docs, secrets) conformance gate'de PASS olmalı
16. **PR merge için contract (routes snapshot) PASS zorunlu**: API route'ları snapshot ile eşleşmeli, değişiklik varsa snapshot güncellenmeli
17. **PR merge için DB contract PASS zorunlu**: DB şeması snapshot ile eşleşmeli, değişiklik varsa snapshot güncellenmeli
18. **PR merge için error-contract PASS zorunlu**: Error response'ları standard envelope formatında olmalı (ok:false, error_code, request_id, details?)
19. **Yeni gate/health endpoint eklerken**: `docs/runbooks/incident.md` ve `ops/triage.ps1` güncellenmeli
20. **Repo layout değişikliği**: `docs/REPO_LAYOUT.md` ve `docs/ARCHITECTURE.md` güncellenmeli, `ops/doctor.ps1` PASS kalmalı
21. **Incident bundle zorunlu**: Incident'lerde incident bundle path veya içeriği eklenmeli
22. **SLO check release öncesi**: Release öncesi SLO check konsülte edilmeli; tekrarlayan FAIL/WARN durumunda incident bundle + runbook adımları gerekli
23. **Latency SLO warm-up ile**: Latency SLO değerlendirmesi warm-up ile ölçülmeli; sadece cold-start spike'ları release'i bloklamaz
24. **Release blockers availability/p95/error-rate**: Release kararı sadece availability, p95 latency ve error rate'e göre verilir; p50 bilgilendirme amaçlıdır ve Windows/Docker dev ortamında WARN gösterebilir
25. **PR merge için security-gate PASS zorunlu**: Route/middleware security audit PASS olmalı; admin/panel surface ve state-changing route'lar security policy'ye uygun olmalı
26. **PROD wildcard CORS yasak**: Production ortamında CORS_ALLOWED_ORIGINS env var ile strict allowlist kullanılmalı; wildcard (*) CORS sadece dev/local ortamında kullanılabilir
27. **Yeni ops gate/check entegrasyonu**: Yeni ops gate veya check eklendiğinde ops_status.ps1'e entegre edilmeli; unified dashboard tüm ops check'leri içermeli
28. **Auth surface auth-security gate PASS zorunlu**: Auth surface (admin/panel/auth endpoints) için auth-security gate PASS olmalı; unauthorized access protection ve rate limiting doğrulanmalı
29. **Tenant-boundary gate PASS zorunlu**: Tenant-boundary gate PASS olmalı; cross-tenant access prevention ve tenant isolation doğrulanmalı
30. **World-spine gate PASS zorunlu**: World-spine gate PASS olmalı; enabled worlds için route/controller surface ve ctx.world lock evidence, disabled worlds için controller directory yokluğu doğrulanmalı
31. **Env-contract gate PASS zorunlu**: Env-contract gate PASS olmalı; production-related changes için required env vars ve production guardrails (CORS, session security) doğrulanmalı
32. **Session-posture gate PASS zorunlu**: Session-posture gate PASS olmalı; auth-related PRs için session cookie security flags (Secure, HttpOnly, SameSite) ve auth endpoint security posture doğrulanmalı
33. **Request trace kullanımı zorunlu**: Incident/triage sırasında request_id varsa request_trace çıktısı veya bundle içine eklenmeli
34. **Pazar Storage Posture PASS/WARN zorunlu**: Release öncesi `ops/pazar_storage_posture.ps1` PASS/WARN olmalı; FAIL durumunda incident bundle zorunlu ve container restart/permission fix gerekli
35. **Storage posture gate release öncesi PASS zorunlu**: Release öncesi `ops/storage_posture_check.ps1` PASS olmalı; UI 500 permission errors önlemek için storage writability garanti edilmeli
36. **Alert pipeline proof obs profile açıkken PASS olmalı**: Observability profile açıkken `ops/alert_pipeline_proof.ps1` PASS olmalı (obs yoksa WARN kabul edilir); Alertmanager -> Webhook pipeline çalışır durumda olmalı
37. **RC0 gate must PASS/WARN before RC0 tag**: RC0 release öncesi `ops/rc0_gate.ps1` PASS veya WARN olmalı; FAIL durumunda RC0 tag oluşturulmamalı; WARN durumunda warnings review edildikten sonra RC0 devam edebilir. Blocking checks: Repository Doctor, Stack Verification, Architecture Conformance (world registry drift), Environment Contract, Security Audit, Auth Security Check, Tenant Boundary (secrets missing → WARN), Session Posture (local/dev → WARN), Schema Snapshot, Error Contract, Release Bundle. Non-blocking: SLO Check (FAIL → WARN), Routes Snapshot (real FAIL stays FAIL), Observability Status (WARN only)
38. **RC0 requires release_check PASS/WARN + bundle attached**: RC0 release için `ops/release_check.ps1` PASS veya WARN olmalı ve `ops/release_bundle.ps1` ile release bundle oluşturulmalı; release bundle evidence folder olarak release notes veya PR'a eklenmeli
39. **RC0 gate truthful policy**: RC0 gate output MUST be truthful: NO PASS if any underlying check FAILs OR if output collection crashes/errors. RC0 gate cannot PASS with skipped/errored checks; missing checks should be FAIL (or at minimum WARN with explicit "SKIPPED due to error"), but RC0 overall must FAIL if a required check was not executed. RC0 requires /up check PASS (Pazar /up endpoint must be healthy in RC0 mode via `ops/verify.ps1 -Release` or `$env:RC0=1`); default (non-RC0) behavior stays backward compatible (optional /up)
40. **RC0 gate cannot produce empty summary**: RC0 gate (`ops/rc0_gate.ps1`) must never produce empty summary; PASS/WARN/FAIL/SKIP counts are mandatory. If no check results are collected (gate error), RC0 gate must FAIL with "No check results collected - gate error" message. Summary format: "Summary: X PASS, Y WARN, Z FAIL, W SKIP" where X+Y+Z+W > 0 always
41. **RC0/Release requires bundle artifact**: RC0 release or release tag creation requires release bundle artifact (`ops/release_bundle.ps1` output) to be attached to PR description or issue. Release bundle zip path (`RELEASE_BUNDLE_ZIP=...`) must be included in PR/issue for release validation
42. **RC0 release requires bundle artifact path and rc0_release.md consulted**: RC0 release requires a release bundle artifact path in PR description (or CI artifact) and `docs/runbooks/rc0_release.md` consulted. Release bundle path (`RELEASE_BUNDLE_PATH=...`) must be included in PR/issue for release validation.
43. **Stability/security/ops changes require audit path and drift report**: Any stability/security/ops change must include latest `AUDIT_PATH` (from `ops/self_audit.ps1`) and `drift_report.md` summary (from `ops/drift_monitor.ps1`) in PR description. If drift detected, review and document intentional changes.
44. **Product spine changes require product_spine_check PASS (or WARN if no docker) and proof update**: Product spine changes (routes, middleware, controller changes for Product Read-Path endpoints) require `ops/product_spine_check.ps1` PASS (or WARN if Docker/services not reachable) and proof update in `docs/PROOFS/product_spine_governance_pass.md`. The check validates route discovery, middleware policy (auth.any, resolve.tenant, tenant.user), and runtime contract (error envelope, request_id, tenant boundary, world boundary).
45. **Product write-path changes require product_spine_check PASS/WARN + proof update**: Product write-path changes (POST/PATCH/DELETE endpoints, validation rules, tenant boundary enforcement) require `ops/product_spine_check.ps1` PASS (or WARN if Docker/services not reachable) and proof update in `docs/PROOFS/product_write_path_pass.md`. The check validates write endpoint runtime contract (unauthorized POST returns 401/403, POST without tenant returns 403, POST invalid payload returns 422 VALIDATION_ERROR, PATCH/DELETE non-existent id returns 404 NOT_FOUND, all with proper JSON envelope and request_id).
46. **All operational packs must be wired into ops_status or explicitly SKIP with documented reason**: All operational packs (ops scripts that perform checks) must be wired into `ops/ops_status.ps1` with explicit metadata (Id, Name, ScriptPath, Blocking status, OnFailAction). If a script is not wired, it must be explicitly marked as SKIP with a documented reason (e.g., "legacy script", "utility only", "superseded by X"). The `ops/ops_drift_guard.ps1` check enforces this rule and will FAIL if unwired scripts are detected.
47. **RC0 readiness = ops_status overall PASS (WARN allowed only if explicitly non-blocking)**: RC0 readiness is determined solely by `ops/ops_status.ps1` overall status. PASS allows release. WARN is allowed only for explicitly non-blocking checks (e.g., SLO p50-only latency warnings, optional observability when Prometheus is absent, non-critical storage posture). FAIL blocks release and triggers automatic incident bundle generation. All blocking checks (doctor, verify, conformance, env-contract, auth-security, tenant-boundary, session-posture, error-contract, routes-snapshot, schema-snapshot, product_spine_check, ops_drift_guard, storage_permissions) must PASS for RC0 release.
48. **Storage-permissions gate PASS required before RC0 tag**: Storage permissions check (`ops/storage_permissions_check.ps1`) must PASS before RC0 tag creation. This ensures Laravel storage directories are correctly configured with proper permissions, preventing Monolog permission denied errors (`laravel.log` write failures). The check validates storage/logs directories exist and are writable, laravel.log is writable (touch + append test), and bootstrap/cache directory is writable. Named volumes (`pazar_storage`, `pazar_cache`) and the `pazar-perms-init` one-shot service must be correctly configured in `docker-compose.yml`.
49. **Storage posture gate PASS required for RC0**: Storage posture check (`ops/storage_posture_check.ps1`) must PASS before RC0 tag creation. This ensures Laravel storage and cache directories are writable by the runtime user (`www-data`), preventing Monolog permission denied errors (`laravel.log` write failures). The check validates `/var/www/html/storage` and `/var/www/html/storage/logs` directories exist and are writable by `www-data`, `laravel.log` can be created/appended by `www-data`, and `/var/www/html/bootstrap/cache` is writable. The entrypoint script (`work/pazar/docker/docker-entrypoint.sh`) must run on every container start to ensure permissions are fixed deterministically. Named volumes (`pazar_storage`, `pazar_cache`) and `pazar-app` service must have `user: "0:0"` for root permissions in `docker-compose.yml`.
50. **Storage write gate must PASS before RC0/product work continues**: Storage write check (`ops/storage_write_check.ps1`) must PASS before RC0 tag creation and product work continues. This ensures Laravel log append works from container runtime context (www-data user perspective), preventing Monolog "Failed to open stream: Permission denied" errors. The check validates required paths exist (`/var/www/html/storage`, `/var/www/html/storage/logs`, `/var/www/html/bootstrap/cache`), `laravel.log` exists, and **CRITICAL**: worker append test - www-data user can append to `laravel.log` (`su -s /bin/sh www-data -c "echo test >> laravel.log"`). This validates actual runtime behavior that php-fpm workers will experience, not just permission checks as root. The entrypoint script (`work/pazar/docker/docker-entrypoint.sh`) must set `chmod 0666` on `laravel.log` for bulletproof append-safe permissions (worker can write even if ownership gets weird) and perform worker perspective write check. The init service (`pazar-perms-init` in `docker-compose.yml`) must also create `laravel.log` and set `chmod 0666`. If worker append fails, the check returns FAIL with remediation hints. If `su` command is missing, returns WARN with manual check instructions.
51. **Product spine checks must PASS before enabling any write-path for Product**: Product spine check (`ops/product_spine_check.ps1`) must PASS before enabling any write-path (POST/PATCH/DELETE) for Product API. This ensures Commerce read-path endpoints (GET `/api/v1/commerce/listings` and GET `/api/v1/commerce/listings/{id}`) are STABLE with consistent envelope, pagination (limit clamp 1..100, default 20, cursor-based), tenant boundary enforcement (no cross-tenant leakage, 404 for cross-tenant access), and world boundary enforcement (commerce only). The check validates contract tests: 401 proof (unauthorized GET returns 401/403 with JSON envelope, `ok:false`, `request_id` non-null), 403 proof (auth without tenant returns 403 with JSON envelope, `ok:false`, `request_id` non-null), 200 proof (auth + tenant returns 200 with `ok:true`, `data.items` array, `request_id` non-null), 404 proof (non-existent ID returns 404 with `ok:false`, `error_code: "NOT_FOUND"`, `request_id` non-null). Environment variables: `TENANT_TEST_ID` or `PRODUCT_TEST_TENANT_ID` (tenant UUID), `PRODUCT_TEST_TOKEN` or `PRODUCT_TEST_EMAIL` + `PRODUCT_TEST_PASSWORD` (auth token). If credentials missing, returns WARN (non-blocking locally), but FAIL in CI if secrets are configured and check fails. Response envelope must match contract: `{ ok:true, data:{ items:[...], cursor:{next}, meta:{count,limit} }, request_id }` for 200 OK, `{ ok:false, error_code:"NOT_FOUND", message:"...", request_id }` for 404 NOT_FOUND.
52. **Write-path requires both product_spine_check and product_write_spine_check PASS**: Write-path changes (POST/PATCH/DELETE endpoints for Product API) require both `ops/product_spine_check.ps1` PASS (read-path must be STABLE) and `ops/product_write_spine_check.ps1` PASS (write-path contract tests must pass). The product_write_spine_check validates: 401 proof (unauthorized POST returns 401/403 with JSON envelope, `ok:false`, `request_id` non-null), 403 proof (auth without tenant returns 403 with JSON envelope, `ok:false`, `request_id` non-null), 201 proof (auth + tenant returns 201 with `ok:true`, `data.id`, `data.item`, `request_id` non-null), 200 proof (read-after-write returns 200 with `ok:true`, `data.item`, `request_id` non-null), 404 proof (cross-tenant read returns 404 with `ok:false`, `error_code: "NOT_FOUND"`, `request_id` non-null, no leakage). Environment variables: `TENANT_TEST_ID` or `PRODUCT_TEST_TENANT_ID` (tenant UUID), `TENANT_B_TEST_ID` (optional, for cross-tenant test), `PRODUCT_TEST_TOKEN` or `PRODUCT_TEST_EMAIL` + `PRODUCT_TEST_PASSWORD` (auth token). If credentials missing, returns WARN (non-blocking locally), but FAIL in CI if secrets are configured and check fails. Tenant boundary must be enforced: `tenant_id` must be set from resolved tenant context (NOT from request body). World boundary must be enforced: `world='commerce'` must be enforced (NOT from request body). Response envelope must match contract: `{ ok:true, data:{ id, item }, request_id }` for 201 CREATED.
53. **Enabled worlds product read-path routes MUST be tenant-scoped (auth.any + resolve.tenant + tenant.user)**: All enabled worlds (commerce, food, rentals) must have GET `/api/v1/{world}/listings` and GET `/api/v1/{world}/listings/{id}` routes protected with `auth.any`, `resolve.tenant`, and `tenant.user` middleware. This ensures tenant-scoped queries (no cross-tenant leakage), world enforcement (ctx.world lock), and consistent security posture across all enabled worlds. The `ops/product_spine_check.ps1` gate validates routes exist and middleware is present for all enabled worlds (read from `work/pazar/config/worlds.php`). Routes snapshot (`ops/snapshots/routes.pazar.json`) is used for static validation (no Docker required). If routes snapshot missing, gate attempts to generate it via `ops/routes_snapshot.ps1`, or falls back to filesystem check (WARN). Disabled worlds are not checked by this gate (world governance gate handles disabled-world code policy). Exit codes: 0 PASS (all enabled worlds have routes and middleware), 2 WARN (routes snapshot missing or inconclusive), 1 FAIL (routes missing or middleware incorrect).
54. **Product spine governance gate PASS required (RC0 and beyond)**: Product spine governance check (`ops/product_spine_governance.ps1`) must PASS before RC0 tag creation and for all subsequent releases. This ensures all enabled worlds (commerce, food, rentals) have required API spine routes (GET/POST/PATCH/DELETE `/api/v1/{world}/listings` and GET `/api/v1/{world}/listings/{id}`) with correct middleware (`auth.any`, `resolve.tenant`, `tenant.user`), and disabled worlds (services, real_estate, vehicle) have NO routes (disabled-world policy). The gate validates routes exist and middleware is present for all enabled worlds (read from `work/pazar/config/worlds.php`), validates disabled worlds have NO routes, and uses routes snapshot (`ops/snapshots/routes.pazar.json`) for static validation (no Docker required). If routes snapshot missing, gate falls back to filesystem check (WARN). Exit codes: 0 PASS (all enabled worlds have routes and middleware, disabled worlds have no routes), 2 WARN (routes snapshot missing or inconclusive), 1 FAIL (routes missing, middleware incorrect, or disabled world has routes). Commerce write-path (POST/PATCH/DELETE) must return 501 NOT_IMPLEMENTED stub (no DB writes, business logic absent).
55. **Any change to /api/v1/* product endpoints requires product_spine_check PASS/WARN; write endpoints require allowlist + proof**: Any change under `work/pazar/routes/api.php` or `Api/Commerce` controllers must pass `ops/product_spine_check.ps1` (PASS or WARN acceptable if snapshot missing). The gate validates: Commerce read routes exist (GET /api/v1/commerce/listings and /{id}), middleware contract (auth.any + resolve.tenant + tenant.user), write-path lock (POST/PUT/PATCH/DELETE must be allowlisted or return 501 NOT_IMPLEMENTED), world boundary evidence (WARN-only), tenant boundary evidence (WARN-only). Write endpoints that are not stubs must be explicitly allowlisted in `ops/policy/product_spine_allowlist.json` with reason and ticket. Allowlist format: `{ "allow_write_endpoints": [{"method":"POST","uri":"/api/v1/commerce/listings","reason":"RC1 create listing","ticket":"TBD"}] }`. Proof must be updated in `docs/PROOFS/product_spine_governance_pass.md` when allowlisting write endpoints or changing rule semantics.
56. **Product spine E2E gate must PASS before product write expansion**: Product spine E2E check (`ops/product_spine_e2e_check.ps1`) must PASS before product write expansion (create → list → show + tenant boundary validated). The gate validates end-to-end: health check, credential validation (WARN if missing in local, FAIL in CI), login/token acquisition, create product (POST /api/v1/products), list products (GET /api/v1/products), show product (GET /api/v1/products/{id}), cross-tenant isolation (404/403 for cross-tenant access), error contract validation (422 error envelope with ok:false, error_code, message, request_id). Environment variables: `PRODUCT_TEST_EMAIL`, `PRODUCT_TEST_PASSWORD`, `TENANT_A_SLUG`, `TENANT_B_SLUG` (optional, for cross-tenant test), `WORLD` (default: commerce). If credentials missing in local/dev, returns WARN and SKIPs (non-blocking). If credentials missing in CI, returns FAIL (secrets must be present). Exit codes: 0 PASS (all E2E checks passed), 2 WARN (credentials missing in local, health check failed, or cross-tenant test skipped), 1 FAIL (E2E check failed, credentials missing in CI, or security issue detected). Integrated into `ops/ops_status.ps1` as BLOCKING check (after Product Spine Check). CI workflow (`.github/workflows/product-spine.yml`) runs on push/PR to main/develop with secrets configured.
57. **RC0 requires smoke-surface gate PASS/WARN (FAIL blocks release)**: Smoke surface gate (`ops/smoke_surface.ps1`) must PASS or WARN before RC0 tag creation. FAIL blocks release. The gate validates critical surfaces don't return 500/regression errors: Pazar /up → 200, Pazar /metrics → 200 AND Content-Type starts with "text/plain" AND body contains pazar_ metric AND no BOM artifact, API error contract smoke (GET /api/non-existent-endpoint → 404 JSON envelope includes request_id non-null), Admin UI surface must not 500 (GET /ui/admin/control-center no auth should be 200/302/401/403, BUT MUST NOT be 500). If response is 500 or contains Monolog "Permission denied" in body, gate FAILs with remediation hints (storage/logs and bootstrap/cache writable by php-fpm user www-data, ensure runtime permission fix executes on every container start, confirm storage volume is named volume not bind mount). Optional (WARN-only): If Prometheus reachable (9090), verify /api/v1/targets has pazar job up; else WARN. Exit codes: 0 PASS (all critical checks passed), 2 WARN (optional Prometheus check skipped or failed), 1 FAIL (critical check failed, 500 error, contract violation). Integrated into `ops/ops_status.ps1` as BLOCKING check. CI workflow (`.github/workflows/smoke-surface.yml`) runs on push/PR to main/develop, brings up core stack, runs smoke_surface.ps1, uploads logs on failure, always cleans up. This ensures Monolog storage/logs permission errors and other critical failures are caught before release, not just as "one-time" issues.
58. **RC0 release requires release bundle and rc0_release runbook updates when entrypoints or gates change**: RC0 release process requires release bundle generator (`ops/release_bundle.ps1`) to create timestamped folder (`_archive/releases/rc0-YYYYMMDD-HHMMSS/`) with minimum sufficient evidence files (meta.txt, ops_status.txt, incident_bundle_link.txt, routes_snapshot.txt, schema_snapshot.txt, changelog_unreleased.txt, version.txt, architecture.txt, repo_layout.txt, rules.txt, proofs_index.txt). Missing optional files result in WARN (exit code 2), not FAIL. Release bundle folders are untracked (gitignored). RC0 release runbook (`docs/runbooks/rc0_release.md`) must be updated when entrypoints (API routes, CLI commands, UI routes) or gates (ops checks, CI workflows) change. The runbook documents preconditions (repo clean, core stack up, ops status PASS/WARN), release steps (doctor, ops status, release bundle generation), tagging discipline (tag name format: rc0-YYYYMMDD, tag must point to commit with PASS/WARN gates only, if FAIL → fix first then tag), evidence expectations (release bundle folder contains ops_status + snapshots + rules + proofs list), and rollback procedure (git checkout/tag only; no data wipe). Tag creation is manual (do not automate). This ensures deterministic, repeatable RC0 release process that any engineer can follow.
59. **Product API değişikliği yapılacaksa product-contract gate PASS zorunlu; product-e2e CI'da PASS hedef**: Product API değişikliği (routes, middleware, controller changes for enabled/disabled worlds) yapılacaksa `ops/product_contract.ps1` gate PASS zorunlu. Gate validates: enabled worlds (commerce, food, rentals) have required routes (GET list, GET show, POST, PATCH, DELETE) with required middleware (auth.any, tenant.resolve, tenant.user), disabled worlds (services, real_estate, vehicle) have NO routes (ZERO TOLERANCE). Exit codes: 0 PASS, 2 WARN (optional middleware missing, PATCH found as PUT), 1 FAIL (missing routes, missing middleware, disabled world has routes). `ops/product_e2e.ps1` gate is optional (non-blocking in ops_status, WARN if credentials missing), but CI'da PASS hedef (credentials provided via GitHub Secrets). E2E gate validates full CRUD cycle (CREATE → LIST → SHOW → UPDATE → DELETE → SHOW 404) for all enabled worlds. Both gates integrated into `ops/ops_status.ps1` (product_contract: blocking, product_e2e: non-blocking). CI workflows (`.github/workflows/product-contract.yml`, `.github/workflows/product-e2e.yml`) run automatically on routes/config changes (contract) or Pazar code changes (e2e). This ensures Product API contract compliance and catches drift automatically.
60. **All route-driven ops gates must use canonical route JSON normalization helper; no direct ConvertFrom-Json of artisan output**: All ops scripts that parse Laravel `route:list --json` output must use `ops/_lib/routes_json.ps1` helper functions (`Get-RawPazarRouteListJson`, `Convert-RoutesJsonToCanonicalArray`) instead of direct `ConvertFrom-Json`. This ensures deterministic route parsing across different Laravel JSON output formats (array, object with headers/rows, object with data). The helper normalizes routes to canonical format with `method`, `method_primary`, `uri`, `name`, `action`, `middleware`, `domain` fields, handles BOM trimming, and provides deterministic ordering. Route-driven gates include: `ops/routes_snapshot.ps1`, `ops/security_audit.ps1`, `ops/tenant_boundary_check.ps1`, `ops/auth_security_check.ps1`, `ops/world_spine_check.ps1`. All gates must include sanity check: route count must be > 20 (FAIL with hint if too low, indicates JSON parse mismatch or artisan output changed). This ensures route-driven gates read the REAL route surface deterministically, preventing false positives (e.g., "Current routes: 2/4" when app has 100+ routes).
61. **RC0 release blocker: ops_status + product_e2e_contract PASS/WARN şart**: RC0 release requires `ops/ops_status.ps1` to PASS or WARN (no blocking FAILs). Specifically, `ops/product_e2e_contract.ps1` gate must PASS or WARN (credentials missing = WARN, not FAIL). The gate validates: unauthorized access (401/403 + JSON envelope + request_id), tenant missing (403 + request_id), world invalid (400 WORLD_CONTEXT_INVALID if implemented), happy path smoke (authenticated CRUD: GET list, POST create, PATCH update, DELETE), cross-tenant leakage (Tenant A creates, Tenant B accesses → 404 NOT_FOUND, no leakage). Gate uses snapshot-driven route discovery from `ops/snapshots/routes.pazar.json` (falls back to default patterns if snapshot missing). Missing credentials result in WARN (not FAIL) to allow local development. Cross-tenant leakage test requires `TENANT_B_SLUG`; if missing, test is skipped (WARN). CI workflow (`.github/workflows/product-e2e.yml`) runs automatically on push/PR to main/develop, uploads logs/incident bundle on failure. This ensures Product API spine (read/write) + tenant/world boundary + error envelope + request_id + metrics + alerts chain is validated end-to-end before RC0 release.
62. **Product-contract gate PASS zorunlu (RC0+ sonrası ürün değişiklikleri)**: Product API değişikliği (routes, middleware, controller changes for enabled/disabled worlds) yapılacaksa `ops/product_contract_check.ps1` gate PASS zorunlu. Gate validates end-to-end: unauthorized access (no token → 401/403 + JSON envelope + request_id), tenant missing (no X-Tenant-Id → 403/400 + request_id), happy path CRUD (GET list, POST create, GET by id, PATCH update, DELETE, GET deleted → 404), cross-tenant isolation (Tenant B cannot access Tenant A's resources → 404 NOT_FOUND, no leakage), world boundary (invalid world context → 400 WORLD_CONTEXT_INVALID if implemented). Gate uses snapshot-driven route discovery from `ops/snapshots/routes.pazar.json` (falls back to default patterns if snapshot missing). Missing credentials result in WARN (not FAIL) to allow local development. Exit codes: 0 PASS (all checks passed), 2 WARN (credentials missing or optional checks skipped), 1 FAIL (contract violation, leakage detected, or security issue). Integrated into `ops/ops_status.ps1` as BLOCKING check. CI workflow (`.github/workflows/product-contract.yml`) runs automatically on push/PR to main/develop affecting routes/config, brings up core stack, runs both `product_contract.ps1` (route/config check) and `product_contract_check.ps1` (E2E validation), uploads logs/incident bundle on failure. This ensures Product API contract compliance and catches drift/leakage automatically before release.
63. **Product-contract gate (spine validation) PASS required for RC0; spine must match routes snapshot**: Product API spine documentation (`docs/product/PRODUCT_API_SPINE.md`) must match actual public surface (routes snapshot). `ops/product_contract.ps1` gate validates: [A1] Spine file exists and has "Implemented endpoints" sections per world (commerce/food/rentals). [A2] For each endpoint marked IMPLEMENTED in spine, there must be a matching route in snapshot (method + path, under /api/v1/<world>/...). [A3] For each route present in snapshot under /api/v1/<world>/listings*, must be present in spine (no undocumented public endpoints). [A4] Middleware posture (from snapshot action/middleware fields if present, else WARN): must include auth.any + resolve.tenant + tenant.user for protected surfaces; WARN if middleware info is missing in snapshot; FAIL if present but missing required guards. [A5] Error-contract posture smoke: endpoints in spine declare error envelope format section; if docker available, live checks (unauthorized returns 401/403 with ok:false + request_id, not found returns 404 NOT_FOUND with ok:false + request_id). Gate uses routes snapshot `ops/snapshots/routes.pazar.json` (preferred) or falls back to grep routes files. Exit codes: 0=PASS, 2=WARN, 1=FAIL. Integrated into `ops/ops_status.ps1` as BLOCKING check. CI workflow (`.github/workflows/product-contract.yml`) runs automatically on push/PR to main/develop, no docker required for baseline checks (docker optional if available). This ensures Product API spine documentation stays aligned with actual routes, preventing drift between docs and implementation.
64. **Product-e2e gate release öncesi PASS/WARN; FAIL'de incident bundle + request_trace zorunlu**: Product API değişikliği (routes, middleware, controller changes for enabled worlds) yapılacaksa `ops/product_e2e.ps1` gate release öncesi PASS veya WARN olmalı. Gate validates: H-OS health (GET /v1/health → 200 ok:true), Pazar metrics (GET /metrics → 200 Content-Type text/plain), Product spine validation (GET /api/v1/products without world → 422 VALIDATION_ERROR with request_id), Product with world but no auth (GET /api/v1/products?world=commerce → 401/403 with error envelope), Listings per enabled world unauthorized (GET /api/v1/{world}/listings → 401/403 with error envelope), Auth-required E2E (POST create → GET show → PATCH update → DELETE → GET after delete 404) for all enabled worlds (commerce, food, rentals), Cross-tenant leakage check (Tenant B cannot access Tenant A's resources → 404 NOT_FOUND). Gate uses `Invoke-HttpJson` helper (curl.exe -sS -i) for HTTP requests, validates error envelopes (`ok:false`, `error_code`, `request_id` non-empty UUID-ish), validates ok envelopes (`ok:true`, `request_id` present, header matches body if present). Missing credentials (TenantId/AuthToken) result in WARN (auth-required tests skipped), but public contract tests still run. Exit codes: 0=PASS (all checks passed), 2=WARN (credentials missing or optional checks skipped), 1=FAIL (contract violation, missing request_id, wrong status expectations). Integrated into `ops/ops_status.ps1` as NON-BLOCKING check (optional). CI workflow (`.github/workflows/product-e2e.yml`) runs automatically on push/PR to main/develop affecting routes/controllers, brings up core stack, uses GitHub Secrets for credentials (`PRODUCT_TEST_TENANT_ID`, `PRODUCT_TEST_AUTH_TOKEN`, `PRODUCT_TEST_TENANT_B_ID`), uploads logs/incident bundle on failure, always cleans up. On FAIL: incident bundle generation (`ops/incident_bundle.ps1`) and request trace (`ops/request_trace.ps1 -RequestId <request_id>`) zorunlu for debugging. This ensures Product API contract + boundary + error envelope + request_id + metrics/basic health is validated end-to-end before release.
65. **RC0 gate: Merge/release only if rc0_check PASS (WARN allowed only if documented in release bundle note)**: RC0 release requires `ops/rc0_check.ps1` gate to PASS (all blocking checks passed) or WARN (no blocking failures, but warnings present). FAIL blocks merge/release. The gate runs all required checks in deterministic order: Repository Doctor, Stack Verification, Conformance, Security Audit, Environment Contract, Session Posture, SLO Check (-N 30), Observability Status (optional), Product E2E (optional), Tenant Boundary. Blocking checks (doctor, verify, conformance, security_audit, env_contract, session_posture_check, slo_check blocking metrics, tenant_boundary blocking parts, product_e2e contract failures) must PASS. Optional checks (observability_status, product_e2e if credentials missing) may WARN/SKIP. WARN is acceptable only if documented in release bundle note (`ops/rc0_release_bundle.ps1` output). On FAIL, incident bundle is automatically generated. Exit codes: 0=PASS, 2=WARN, 1=FAIL using Invoke-OpsExit (CI exits, interactive returns). CI workflow (`.github/workflows/rc0-check.yml`) runs automatically on pull_request/push to main/develop, brings up core stack, runs rc0_check.ps1, uploads logs/incident bundle on failure, always cleans up. This ensures RC0 release readiness is validated with a single command before merge/release.
66. **/metrics must be root + baseline metrics required by alert rules**: The /metrics endpoint MUST exist at ROOT (not /api prefix), return Prometheus text/plain format (Content-Type: "text/plain; version=0.0.4; charset=utf-8"), and include baseline metrics required by alert rules: `pazar_build_info{service="pazar",version="..."} 1`, `pazar_time_seconds <unix_float>`, `pazar_php_memory_usage_bytes <int>`, `pazar_php_memory_peak_bytes <int>`. The endpoint must NOT require web session/CSRF (explicitly remove StartSession and VerifyCsrfToken middleware). Token support is optional (if METRICS_TOKEN env var is set, requires token via X-Metrics-Token header, ?token= query, or Authorization Bearer). If token required and missing/invalid, returns 401 with body "unauthorized\n" and Content-Type text/plain; charset=utf-8. This ensures Prometheus can scrape metrics without Set-Cookie noise and alert rules have required baseline metrics.
67. **All ops runners that forward argument arrays MUST use splatting (@Arguments)**: All ops scripts that invoke other scripts with argument arrays MUST use PowerShell splatting syntax (`& $ScriptPath @Arguments`) instead of direct array passing (`& $ScriptPath $Arguments`). This prevents String[]→Int conversion errors and ensures arguments are correctly passed to called scripts. The $Arguments variable must be initialized as an array: `if ($null -eq $Arguments) { $Arguments = @() }`. Scripts affected: ops_status.ps1, rc0_release_bundle.ps1, release_bundle.ps1, rc0_check.ps1, rc0_gate.ps1, self_audit.ps1, and any helper "Invoke-ScriptCapture" / "Invoke-OpsScript" functions. This ensures deterministic argument passing and prevents parameter type conversion errors.
68. **Product API CRUD gate PASS required before RC0; CRUD operations must be validated end-to-end for all enabled worlds**: Product API CRUD E2E gate (`ops/product_api_crud_e2e.ps1`) must PASS or WARN before RC0 tag creation. The gate validates end-to-end CRUD operations for all enabled worlds (commerce, food, rentals): Create listing (POST), List listings (GET index), Get listing detail (GET show), Update listing (PATCH), Delete listing (DELETE), Verify deletion (GET after delete → 404 NOT_FOUND). Security assertions: Unauthorized access → 401/403 with standard JSON envelope, Missing tenant context → 403 FORBIDDEN, Cross-tenant leakage → 404 NOT_FOUND (no leakage). Contract assertions: Success responses include ok:true envelope with request_id, Error responses include ok:false envelope with error_code and request_id. Missing credentials result in WARN (not FAIL) to allow local development, but public contract tests (unauthorized, no-tenant) still run. Exit codes: 0 PASS (all checks passed), 2 WARN (credentials missing or optional checks skipped), 1 FAIL (contract violation, leakage detected, or security issue). Integrated into `ops/ops_status.ps1` as BLOCKING check. CI workflow (`.github/workflows/product-api-crud-gate.yml`) runs automatically on push/PR to main/develop, brings up core stack, uses GitHub Secrets for credentials (`PRODUCT_TEST_AUTH`, `TENANT_A_SLUG`, `TENANT_B_SLUG`, `TENANT_A_ID`, `TENANT_B_ID`), uploads logs/incident bundle on failure. This ensures Product CRUD behavior is locked under self-auditing gate so product development cannot silently drift.
69. **RC0 bundle requires clean repo (git status --porcelain must be empty); non-ASCII artifacts in root also block bundle creation**: RC0 release bundle (`ops/rc0_release_bundle.ps1` or `ops/release_bundle.ps1`) requires clean repository state. Preflight check: `git status --porcelain` must be empty (FAIL if uncommitted changes found), repo root must not contain non-ASCII filenames (FAIL if found). If preflight fails, bundle creation is aborted with message: "Commit or stash changes; RC0 requires clean repo." The `meta.txt` file in bundle includes "Repo Clean: true/false" field. This ensures RC0 bundles are only created from clean, committed repository state, preventing accidental release of uncommitted changes or problematic artifacts.
70. **OpenAPI MUST match PRODUCT_API_SPINE for implemented endpoints (no drift); write endpoints (POST/PATCH/DELETE) must be documented in OpenAPI with correct response schemas**: OpenAPI specification (`docs/PRODUCT/openapi.yaml`) must match Product API spine documentation (`docs/product/PRODUCT_API_SPINE.md`) for all implemented endpoints. For each endpoint marked IMPLEMENTED in PRODUCT_API_SPINE.md, OpenAPI must contain the same endpoint with matching HTTP method, path, request body schema, response schema, and error responses. Write endpoints (POST/PATCH/DELETE) for enabled worlds (commerce, food, rentals) must be documented in OpenAPI with: [A1] Request body schema (title required max 255, description nullable, price_amount nullable integer min 0, currency nullable size 3, status nullable enum draft|published default draft), [A2] Success response schema (POST: 201 CREATED with `{ ok: true, item: {...}, request_id }`, PATCH: 200 OK with `{ ok: true, item: {...}, request_id }`, DELETE: 204 NO CONTENT with `{ ok: true, deleted: true, id, request_id }`), [A3] Error response schemas (401 UNAUTHORIZED, 403 FORBIDDEN, 404 NOT_FOUND, 422 VALIDATION_ERROR with errors object, 500 TENANT_CONTEXT_MISSING), [A4] X-Request-Id header documentation. `ops/openapi_contract.ps1` gate validates write endpoints exist in OpenAPI (Check 3: Write endpoints in OpenAPI spec). `ops/product_contract_check.ps1` gate validates CRUD flow end-to-end (POST → GET → PATCH → DELETE with proper status codes and response envelopes). `ops/product_e2e.ps1` gate validates full CRUD cycle for all enabled worlds. This ensures OpenAPI is the single source of truth for Product API contract and prevents drift between documentation and implementation.
71. **UI smoke gate must PASS before RC0**: UI smoke gate (`ops/pazar_ui_smoke.ps1`) must PASS before RC0 tag creation. The gate validates: [A1] UI endpoint (`/ui/admin/control-center`) returns 200 OK or 302 Redirect (login redirect acceptable), MUST NOT return 500 Internal Server Error. [A2] After request, scans last N lines of `docker compose logs pazar-app` for permission denied indicators ("Permission denied", "laravel.log" errors, "UnexpectedValueException"). If found, FAIL with clear note: "Logging permission denied likely returned; inspect pazar-app logs." [A3] Exit codes: 0 PASS (UI accessible, no logging errors), 1 FAIL (500 error or logging regression detected), 2 WARN (endpoint not reachable because stack not up; local dev convenience, not blocking). Integrated into `ops/ops_status.ps1` as BLOCKING check (after storage_posture, before product checks). CI workflow (`.github/workflows/pazar-ui-smoke.yml`) runs automatically on push/PR to main/develop affecting docker-entrypoint.sh or docker-compose.yml, brings up core stack, runs pazar_ui_smoke.ps1, uploads docker compose logs as artifact on failure, always cleans up. This ensures UI never 500s due to Monolog permission denied errors and prevents logging regression from returning.

